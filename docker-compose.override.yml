# ============================================================================
# GrepZilla Docker Compose - Development Override
# Adds bind mounts and hot-reload for local development
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # API with hot-reload
  # --------------------------------------------------------------------------
  
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
      target: base  # Use base stage without pre-built venv for dev
    volumes:
      - ./backend:/app/backend:cached
      - ./pyproject.toml:/app/pyproject.toml:ro
      - ./uv.lock:/app/uv.lock:ro
      - api_venv:/app/.venv
    command: >
      sh -c "
        pip install uv &&
        uv sync --frozen --no-install-project &&
        /app/.venv/bin/uvicorn backend.src.api.main:create_app --factory --host 0.0.0.0 --port 8000 --reload
      "
    environment:
      DEBUG: "true"
      APP_ENV: development
      API_RELOAD: "true"

  # --------------------------------------------------------------------------
  # Worker with watchfiles for reload
  # --------------------------------------------------------------------------
  
  worker:
    build:
      context: .
      dockerfile: docker/worker/Dockerfile
      target: base
    volumes:
      - ./backend:/app/backend:cached
      - ./pyproject.toml:/app/pyproject.toml:ro
      - ./uv.lock:/app/uv.lock:ro
      - worker_venv:/app/.venv
      - git_repos:/app/repos
    command: >
      sh -c "
        pip install uv watchfiles &&
        uv sync --frozen --no-install-project &&
        /app/.venv/bin/watchfiles --filter python '/app/.venv/bin/celery -A backend.src.workers.app worker --loglevel=info' ./backend
      "
    environment:
      DEBUG: "true"
      APP_ENV: development
      GIT_CLONE_BASE_DIR: /app/repos

  # --------------------------------------------------------------------------
  # Beat scheduler (no hot-reload needed)
  # --------------------------------------------------------------------------
  
  beat:
    build:
      context: .
      dockerfile: docker/worker/Dockerfile
      target: base
    volumes:
      - ./backend:/app/backend:cached
      - ./pyproject.toml:/app/pyproject.toml:ro
      - ./uv.lock:/app/uv.lock:ro
      - beat_venv:/app/.venv
    command: >
      sh -c "
        pip install uv &&
        uv sync --frozen --no-install-project &&
        /app/.venv/bin/celery -A backend.src.workers.app beat --loglevel=info
      "
    environment:
      DEBUG: "true"
      APP_ENV: development

  # --------------------------------------------------------------------------
  # Migration with bind mounts for dev
  # --------------------------------------------------------------------------
  
  migrate:
    build:
      context: .
      dockerfile: docker/migrate/Dockerfile
      target: base
    volumes:
      - ./backend:/app/backend:cached
      - ./pyproject.toml:/app/pyproject.toml:ro
      - ./uv.lock:/app/uv.lock:ro
      - ./docker/migrate/entrypoint.sh:/app/entrypoint.sh:ro
      - migrate_venv:/app/.venv
    entrypoint: >
      bash -c "
        pip install uv &&
        uv sync --frozen --no-install-project &&
        bash /app/entrypoint.sh
      "

# ----------------------------------------------------------------------------
# Development volumes for virtual environments
# ----------------------------------------------------------------------------

volumes:
  api_venv:
    driver: local
  worker_venv:
    driver: local
  beat_venv:
    driver: local
  migrate_venv:
    driver: local
  git_repos:
    driver: local
