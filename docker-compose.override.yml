# ============================================================================
# GrepZilla Docker Compose - Development Override
# Adds bind mounts and hot-reload for local development
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # API with hot-reload
  # --------------------------------------------------------------------------
  
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
      target: runtime
    volumes:
      - ./backend:/app/backend:cached
    command: >
      uvicorn backend.src.api.main:create_app --factory --host 0.0.0.0 --port 8000 --reload
    environment:
      DEBUG: "true"
      APP_ENV: development
      API_RELOAD: "true"

  # --------------------------------------------------------------------------
  # Worker with watchfiles for reload
  # --------------------------------------------------------------------------
  
  worker:
    build:
      context: .
      dockerfile: docker/worker/Dockerfile
      target: dev
    volumes:
      - ./backend:/app/backend:cached
      - git_repos:/app/repos
    command: >
      sh -c "
        /app/.venv/bin/watchfiles --filter python '/app/.venv/bin/celery -A backend.src.workers.app worker --loglevel=info' ./backend
      "
    environment:
      DEBUG: "true"
      APP_ENV: development
      GIT_CLONE_BASE_DIR: /app/repos

  # --------------------------------------------------------------------------
  # Beat scheduler (no hot-reload needed)
  # --------------------------------------------------------------------------
  
  beat:
    build:
      context: .
      dockerfile: docker/worker/Dockerfile
      target: runtime
    volumes:
      - ./backend:/app/backend:cached
    command: >
      celery -A backend.src.workers.app beat --loglevel=info
    environment:
      DEBUG: "true"
      APP_ENV: development

  # --------------------------------------------------------------------------
  # Migration with bind mounts for dev
  # --------------------------------------------------------------------------
  
  migrate:
    build:
      context: .
      dockerfile: docker/migrate/Dockerfile
      target: runtime
    volumes:
      - ./backend:/app/backend:cached
      - ./alembic:/app/alembic:cached
      - ./alembic.ini:/app/alembic.ini:ro
      - ./docker/migrate/entrypoint.sh:/app/entrypoint.sh:ro
    entrypoint: ["/bin/bash", "/app/entrypoint.sh"]

# ----------------------------------------------------------------------------
# Development volumes
# ----------------------------------------------------------------------------

volumes:
  git_repos:
    driver: local
